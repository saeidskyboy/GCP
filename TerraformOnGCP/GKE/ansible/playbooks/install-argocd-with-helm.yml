- hosts: localhost
  gather_facts: false
  connection: local
  become: false

  collections:
  - community.kubernetes

  tasks:
  - name: Add Argo Helm repository
    kubernetes.core.helm_repository:
      name: argo
      repo_url: https://argoproj.github.io/argo-helm

  - name: Install Argo CD
    kubernetes.core.helm:
      name: argocd
      chart_ref: argo/argo-cd
      release_namespace: argocd
      create_namespace: true # good practice.
      wait: true
      wait_timeout: 300s
      chart_version: "5.16.0"  # Use a recent, stable version. Check for latest: https://artifacthub.io/packages/helm/argo/argo-cd
      values:
        server:
          container:
            image:
              repository: argoproj/argocd-server
              tag: v2.9.3 
          extraArgs:
            - --insecure # For lab only; use TLS in production!

  - name: Wait for Argo CD API server to become ready
    kubernetes.core.wait_for:
      api_version: v1
      kind: Pod
      namespace: argocd
      name: argocd-server
      wait: yes
      wait_timeout: 300
      wait_condition:
        type: Ready
        status: "True"

  - name: Get Argo CD initial admin password
    ansible.builtin.command:
      cmd: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d; echo
    register: argocd_admin_password
    changed_when: false # This command doesn't change anything on the system.

  - name: Print Argo CD initial admin password
    ansible.builtin.debug:
      msg: "Argo CD initial admin password: {{ argocd_admin_password.stdout }}"